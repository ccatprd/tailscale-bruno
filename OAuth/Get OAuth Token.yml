info:
  name: Get OAuth Token
  type: http
  seq: 1

http:
  method: POST
  url: https://api.tailscale.com/api/v2/oauth/token
  headers:
    - name: Content-Type
      value: application/x-www-form-urlencoded
  body:
    type: formUrlEncoded
    data:
      - name: client_id
        value: "{{oauth_client_id}}"
        enabled: true
      - name: client_secret
        value: "{{oauth_client_secret}}"
        enabled: true
      - name: grant_type
        value: client_credentials
        enabled: true
      - name: scope
        value: "all"
        enabled: true

runtime:
  scripts:
    - type: after-response
      code: |
        const body = res.getBody();
        if (body && body.access_token) {
          bru.setEnvVar("access_token", body.access_token);
          console.log("access_token updated from OAuth token response (expires in " + body.expires_in + "s)");
        } else {
          console.log("OAuth token request failed: " + JSON.stringify(body));
        }

settings:
  encodeUrl: true
  timeout: 0
  followRedirects: true
  maxRedirects: 5

docs: |
  # Get OAuth Token

  Exchanges OAuth client credentials for a short-lived Bearer token, then auto-sets `access_token`
  in your environment so all subsequent requests use it immediately.

  ## Flow

  1. Set `oauth_client_id` and `oauth_client_secret` in your environment
  2. Run this request — `access_token` is updated automatically
  3. Run any other request — it uses the new token via `{{access_token}}`

  Tokens expire in 3600 seconds (1 hour). Re-run this request to refresh.

  ## Scope

  Controls what the token can access. `all` grants full access.
  For least-privilege, use specific scopes e.g. `logs:network:read`, `devices:core:read`.

  Available scopes: devices:core:read, devices:core, users:read, users,
  keys:read, keys, dns:read, dns, acl:read, acl,
  logs:read, logs:network:read, webhooks, tailnet:read

  ## Create OAuth clients

  https://login.tailscale.com/admin/settings/oauth
