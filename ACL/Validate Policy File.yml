info:
  name: Validate Policy File
  type: http
  seq: 4

http:
  method: POST
  url: "{{base_url}}/tailnet/{{tailnet}}/acl/validate"
  auth:
    type: bearer
    token: "{{access_token}}"
  headers:
    - name: Content-Type
      value: application/json
  body:
    type: json
    data: |
      {
        "hosts": {
          "host1": "100.117.222.1",
          "host2": "100.117.222.2"
        },
        "acls": [
          {
            "action": "accept",
            "src": ["host1"],
            "dst": ["host2:22"]
          }
        ],
        "tests": [
          {
            "src": "host1",
            "accept": ["host2:443"],
            "deny": ["host2:22"]
          }
        ]
      }

settings:
  encodeUrl: true
  timeout: 0
  followRedirects: true
  maxRedirects: 5

docs: |
  # Validate Policy File

  Validates a proposed ACL policy WITHOUT applying it to your tailnet. Safe to run at any time.

  ## How it works

  You send a complete ACL policy in the request body. Tailscale checks it for syntax errors
  and optionally runs connectivity assertions (tests) against it to verify your rules behave
  as intended.

  ## The "tests" array

  The tests block lets you write expectations about what your ACL should allow or deny.
  Think of it like unit tests for your firewall rules.

  Each test entry has:
    - "src":    the source host or user making the connection
    - "accept": ports/hosts that SHOULD be reachable from src (test fails if blocked)
    - "deny":   ports/hosts that SHOULD be blocked from src (test fails if allowed)

  ## Reading the example body

  The ACL rule allows host1 → host2:22 (SSH) only.

  The test intentionally checks the WRONG expectations to demonstrate a failure response:
    - "accept": ["host2:443"]  → expects 443 to be allowed, but it's blocked → FAIL
    - "deny":   ["host2:22"]   → expects 22 to be blocked, but it's allowed → FAIL

  To see a passing response, swap accept and deny in the tests block.

  ## Responses

  SUCCESS (all tests pass):
    {} — empty object with 200 OK

  FAILURE (syntax error or test assertion failed):
    {
      "message": "test(s) failed",
      "data": [
        {
          "user": "host1",
          "errors": ["[acl test error]: address \"host2:443\": want: Accept, got: Drop"]
        }
      ]
    }

  ## Important

  This endpoint does NOT modify your live ACL. Use "Update Policy File" to apply changes.
